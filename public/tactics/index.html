<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Soccer Animation</title>
  <style>
:root{ --controls-h: 48px; --frame-pad: 8px; }
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,sans-serif;background:#0b5e20;color:#eee;overflow:hidden}

/* Hide scenario dropdown when in iframe */
body.embedded #scenarioSelect { display: none; }
body.embedded label:has(#scenarioSelect) { display: none; }

.controls{position:fixed;top:0;left:0;right:0;display:flex;gap:.5rem;align-items:center;background:#114d1e;padding:.35rem .6rem;border-bottom:1px solid rgba(255,255,255,.1);height:var(--controls-h);z-index:10;flex-wrap:wrap}
.controls label{display:inline-flex;align-items:center;gap:.25rem;font-size:.9rem;opacity:.95}
.controls select,.controls button{font-size:.9rem}
.scrubber{width:320px;flex-shrink:0}

.stage{position:absolute;top:var(--controls-h);left:0;right:0;bottom:0;padding:var(--frame-pad)}
.frame{width:100%;height:100%;display:flex;align-items:center;justify-content:center;}

svg{display:block; background:#146c2e; border:1px solid rgba(0,0,0,.25); border-radius:8px; box-shadow:0 6px 16px rgba(0,0,0,.25);
     aspect-ratio: 1000 / 650; 
     max-height: calc(100vh - var(--controls-h) - (var(--frame-pad)*2));
     max-width: calc( (100vh - var(--controls-h) - (var(--frame-pad)*2)) * (1000 / 650) );
     width: min(100%, calc( (100vh - var(--controls-h) - (var(--frame-pad)*2)) * (1000 / 650) ));
     height: auto;
}

.token{stroke:#111;stroke-width:2}
.label{font-size:14px;fill:#fff;text-shadow:0 1px 2px rgba(0,0,0,.6)}
.jersey-number{font-size:13px;font-weight:700;fill:#fff;text-shadow:0 1px 3px rgba(0,0,0,.9);pointer-events:none;text-anchor:middle;dominant-baseline:middle}
.offside-line{stroke:#ff4d4d;stroke-width:3;opacity:.9}
.spotlight{fill:none;stroke:#fff;stroke-width:4;stroke-dasharray:6 6;opacity:.9}
.pass-arc{fill:none;stroke:#fff;stroke-width:3;stroke-linecap:round}
.pitch-mark{stroke:#e6ffe6;stroke-width:3;fill:none;opacity:.75}
.center-dot{fill:#e6ffe6}

.annotation{font-size:22px;font-weight:600;fill:#111}
.annotation-bg{fill:rgba(255,255,255,.92);stroke:#111;stroke-width:2;rx:8;ry:8}

.text-label{font-size:18px;font-weight:700;fill:#fff;stroke:#000;stroke-width:3;paint-order:stroke;stroke-linejoin:round}

.arrow-line{stroke-width:3;opacity:.85;stroke-linecap:round}
.arrow-head{opacity:.85;stroke:#000;stroke-width:1}

.loading{text-align:center;padding:2rem;color:#fff}
.error{background:#d32f2f;color:#fff;padding:1rem;margin:1rem;border-radius:4px}
  </style>
</head>
<body>
  <header class="controls" id="controlsBar">
    <button id="playBtn">Play</button>
    <button id="pauseBtn">Pause</button>

    <label>Speed
      <select id="speedSelect">
        <option value="0.5">0.5×</option>
        <option value="0.75">0.75×</option>
        <option value="1" selected>1×</option>
        <option value="1.5">1.5×</option>
        <option value="2">2×</option>
      </select>
    </label>

    <input id="scrubber" type="range" min="0" max="10000" value="0" step="16" class="scrubber" />

    <label><input id="toggleLabels" type="checkbox" checked /> Labels</label>
    <label><input id="toggleOffside" type="checkbox" checked /> Offside Line</label>
    <label><input id="toggleLoop" type="checkbox" /> Loop</label>

    <label>Scenario
      <select id="scenarioSelect">
        <option value="">Loading...</option>
      </select>
    </label>

    <button id="snapshotBtn">PNG Snapshot</button>
  </header>

  <main class="stage">
    <div class="frame">
      <svg id="pitch" viewBox="0 0 1000 650" preserveAspectRatio="xMidYMid meet" role="img" aria-label="Soccer pitch animation"></svg>
    </div>
  </main>

  <script>
let isPlaying=false, speed=1, currentTime=0, duration=0, lastTick=0, rafId=null;
let activeScenario=null;
let manifestData=null;

const svg=document.getElementById('pitch');
const playBtn=document.getElementById('playBtn');
const pauseBtn=document.getElementById('pauseBtn');
const speedSelect=document.getElementById('speedSelect');
const scrubber=document.getElementById('scrubber');
const toggleLabels=document.getElementById('toggleLabels');
const toggleOffside=document.getElementById('toggleOffside');
const toggleLoop=document.getElementById('toggleLoop');
const scenarioSelect=document.getElementById('scenarioSelect');
const snapshotBtn=document.getElementById('snapshotBtn');
const controlsBar=document.getElementById('controlsBar');

const NS="http://www.w3.org/2000/svg";
let gPitch, gMarks, gPlayers, gNumbers, gLabels, gOverlay, gAnnots;
const playerNodes=new Map();

const Easing={
  linear: t => t,
  quadOut: t => 1-(1-t)*(1-t),
  quadInOut: t => t<.5 ? 2*t*t : 1-Math.pow(-2*t+2,2)/2,
};

const FALLBACK_SCENARIOS = {
  onsideBeatsTrap: {
    id: "onsideBeatsTrap",
    name: "Beats the Trap (Onside)",
    chapter: 4,
    section: "The Offside Trap",
    description: "Attacker times run perfectly to stay onside",
    players: [
      {id:"D1",x:600,y:180,color:"#60a5fa",label:"D1"},
      {id:"D2",x:600,y:325,color:"#60a5fa",label:"D2"},
      {id:"D3",x:600,y:470,color:"#60a5fa",label:"D3"},
      {id:"A9",x:540,y:325,color:"#f87171",label:"A9"},
      {id:"BALL",x:520,y:325,color:"#fff",r:8,label:""}
    ],
    actions: [
      {type:"move",id:"D1",from:{x:600,y:180},to:{x:660,y:180},start:0,end:1100,easing:"quadOut"},
      {type:"move",id:"D2",from:{x:600,y:325},to:{x:660,y:325},start:0,end:1100,easing:"quadOut"},
      {type:"move",id:"D3",from:{x:600,y:470},to:{x:660,y:470},start:0,end:1100,easing:"quadOut"},
      {type:"move",id:"A9",from:{x:540,y:325},to:{x:705,y:305},start:500,end:2000,easing:"quadInOut"},
      {type:"offsideLine",xAtStart:600,xAtEnd:660,start:0,end:1100},
      {type:"passArc",from:{x:520,y:325},to:{x:690,y:305},start:1100,end:1700}
    ],
    annotations: [
      {text:"Onside: level at the pass", x:520, y:70},
      {text:"Defensive line steps up", x:660, y:150, anchor:"end"}
    ]
  },
  
  caughtOffside: {
    id: "caughtOffside",
    name: "Caught by the Trap (Offside)",
    chapter: 4,
    section: "The Offside Trap",
    description: "Attacker runs too early and is caught offside",
    players: [
      {id:"D1",x:600,y:180,color:"#60a5fa",label:"D1"},
      {id:"D2",x:600,y:325,color:"#60a5fa",label:"D2"},
      {id:"D3",x:600,y:470,color:"#60a5fa",label:"D3"},
      {id:"A9",x:560,y:325,color:"#f87171",label:"A9"},
      {id:"BALL",x:520,y:325,color:"#fff",r:8,label:""}
    ],
    actions: [
      {type:"move",id:"D1",from:{x:600,y:180},to:{x:670,y:180},start:0,end:1200,easing:"quadOut"},
      {type:"move",id:"D2",from:{x:600,y:325},to:{x:670,y:325},start:0,end:1200,easing:"quadOut"},
      {type:"move",id:"D3",from:{x:600,y:470},to:{x:670,y:470},start:0,end:1200,easing:"quadOut"},
      {type:"move",id:"A9",from:{x:560,y:325},to:{x:730,y:305},start:400,end:2200,easing:"quadInOut"},
      {type:"offsideLine",xAtStart:600,xAtEnd:670,start:0,end:1200},
      {type:"passArc",from:{x:520,y:325},to:{x:720,y:305},start:1250,end:1800}
    ],
    annotations: [
      {text:"Offside: ahead of 2nd-last defender at the pass", x:145, y:70},
      {text:"Line steps & pass is late → trap works", x:680, y:120, anchor:"end"}
    ]
  }
};

const FALLBACK_MANIFEST = [
  {id: "onsideBeatsTrap", name: "Beats the Trap (Onside)", group: "Offside Mechanics", chapter: 4, section: "The Offside Trap"},
  {id: "caughtOffside", name: "Caught by the Trap (Offside)", group: "Offside Mechanics", chapter: 4, section: "The Offside Trap"}
];

async function loadManifest() {
  try {
    const cacheBuster = Date.now();
    const response = await fetch(`scenarios/manifest.json?v=${cacheBuster}`);
    if (!response.ok) throw new Error('Manifest not found');
    const data = await response.json();
    console.log('Loaded manifest:', data);
    console.log('Is array?', Array.isArray(data));
    return data;
  } catch (error) {
    console.warn('Could not load manifest.json, using fallback scenarios:', error);
    return FALLBACK_MANIFEST;
  }
}

async function loadScenarioById(id) {
  if (FALLBACK_SCENARIOS[id]) {
    console.log('Using fallback scenario:', id);
    return FALLBACK_SCENARIOS[id];
  }
  
  try {
    const cacheBuster = Date.now();
    const response = await fetch(`scenarios/${id}.json?v=${cacheBuster}`);
    if (!response.ok) throw new Error(`Scenario ${id} not found`);
    return await response.json();
  } catch (error) {
    console.error('Failed to load scenario:', id, error);
    throw error;
  }
}

function populateScenarioDropdown(manifest) {
  console.log('Populating dropdown with manifest:', manifest);
  if (!Array.isArray(manifest)) {
    console.error('Manifest is not an array!', typeof manifest, manifest);
    alert('Manifest format error - check console');
    return;
  }
  
  scenarioSelect.innerHTML = '';
  const groups = {};
  manifest.forEach(item => {
    const group = item.group || 'Other';
    if (!groups[group]) groups[group] = [];
    groups[group].push(item);
  });
  
  Object.keys(groups).forEach(groupName => {
    const optgroup = document.createElement('optgroup');
    optgroup.label = groupName;
    groups[groupName].forEach(item => {
      const option = document.createElement('option');
      option.value = item.id;
      option.textContent = item.chapter ? `Ch ${item.chapter} – ${item.name}` : item.name;
      optgroup.appendChild(option);
    });
    scenarioSelect.appendChild(optgroup);
  });
}

function setControlsHeightVar(){
  const h=controlsBar.offsetHeight||48;
  document.documentElement.style.setProperty('--controls-h',h+'px');
}

function el(name,attrs={}){
  const n=document.createElementNS(NS,name);
  for(const[k,v]of Object.entries(attrs)) n.setAttribute(k,v);
  return n;
}

function lerp(a,b,t){return a+(b-a)*t;}

function computeDuration(scn){
  return Math.max(0,...scn.actions.map(a=>a.end||a.start||0));
}

function buildPitch(){
  svg.innerHTML="";
  gPitch=el('g',{id:'gPitch'});
  gMarks=el('g',{id:'gMarks'});
  gOverlay=el('g',{id:'gOverlay'});
  gPlayers=el('g',{id:'gPlayers'});
  gNumbers=el('g',{id:'gNumbers'});
  gLabels=el('g',{id:'gLabels'});
  gAnnots=el('g',{id:'gAnnots'});

  const grass=el('rect',{x:0,y:0,width:1000,height:650,fill:'#146c2e'});
  const outline=el('rect',{x:10,y:10,width:980,height:630,class:'pitch-mark'});
  const halfway=el('line',{x1:500,y1:10,x2:500,y2:640,class:'pitch-mark'});
  const centerCircle=el('circle',{cx:500,cy:325,r:73,class:'pitch-mark'});
  const centerDot=el('circle',{cx:500,cy:325,r:3,class:'center-dot'});
  const boxL=el('rect',{x:10,y:170,width:180,height:310,class:'pitch-mark'});
  const boxR=el('rect',{x:810,y:170,width:180,height:310,class:'pitch-mark'});
  
  // Goals
  const goalL=el('rect',{x:0,y:280,width:10,height:90,fill:'none',stroke:'#fff','stroke-width':3});
  const goalR=el('rect',{x:990,y:280,width:10,height:90,fill:'none',stroke:'#fff','stroke-width':3});

  gPitch.appendChild(grass);
  gMarks.append(outline,halfway,centerCircle,centerDot,boxL,boxR,goalL,goalR);
  svg.append(gPitch,gMarks,gOverlay,gPlayers,gNumbers,gLabels,gAnnots);
}

function buildPlayersForScenario(scn){
  playerNodes.clear(); 
  gPlayers.innerHTML=""; 
  gNumbers.innerHTML="";
  gLabels.innerHTML="";
  for(const p of scn.players){
    const r=p.r??16;
    const token=el('circle',{id:p.id,cx:p.x,cy:p.y,r,fill:p.color,class:'token'});
    gPlayers.appendChild(token);
    
    let numberEl = null;
    if(p.label && p.label.trim() && p.label.length <= 3) {
      numberEl=el('text',{x:p.x-1,y:p.y,textAnchor:'middle',class:'jersey-number'});
      numberEl.setAttribute('dominant-baseline','middle');
      numberEl.textContent=p.label;
      gNumbers.appendChild(numberEl);
    }
    
    const label=el('text',{x:p.x,y:p.y-(r+8),textAnchor:'middle',class:'label'});
    if(p.label && p.label.length > 3) {
      label.textContent=p.label;
    }
    gLabels.appendChild(label);
    
    playerNodes.set(p.id,{token,number:numberEl,label,r});
  }
}

function buildAnnotationsForScenario(scn){
  gAnnots.innerHTML="";
  if(!scn.annotations) return;
  for(const a of scn.annotations){
    const group = el('g', { class: 'annotation' });
    const text = el('text', { x: a.x, y: a.y, class: 'annotation text' });
    if (a.anchor) text.setAttribute('text-anchor', a.anchor);
    text.textContent = a.text;
    const bboxPad = 8;
    const estW = Math.max(140, Math.min(960, a.text.length * 11 + 40));
    const estH = 30;
    let bx = a.x, by = a.y - estH + 6;
    if (a.anchor === 'middle') bx = a.x - estW/2;
    else if (a.anchor === 'end') bx = a.x - estW;
    const bg = el('rect', { x: bx - bboxPad, y: by - bboxPad, width: estW + bboxPad*2, height: estH + bboxPad*2, class: 'annotation-bg' });
    group.appendChild(bg);
    group.appendChild(text);
    gAnnots.appendChild(group);
  }
}

function resetDynamicLayers(){ gOverlay.innerHTML=""; }

function setPlayerPos(id,x,y){ 
  const n=playerNodes.get(id); 
  if(!n) return; 
  n.token.setAttribute('cx',x); 
  n.token.setAttribute('cy',y);
  if(n.number && n.number.textContent) {
    n.number.setAttribute('x',x-1);
    n.number.setAttribute('y',y);
  }
  if(n.label && n.label.textContent) {
    n.label.setAttribute('x',x); 
    n.label.setAttribute('y',y-(n.r+8));
  }
}

function drawOffsideLineAtX(x){ 
  if(!toggleOffside.checked) return; 
  gOverlay.appendChild(el('line',{x1:x,x2:x,y1:10,y2:640,class:'offside-line',id:'offsideLine'})); 
}

function setSpotlight(id,radius){ 
  const n=playerNodes.get(id); 
  if(!n) return; 
  const cx=+n.token.getAttribute('cx');
  const cy=+n.token.getAttribute('cy'); 
  gOverlay.appendChild(el('circle',{cx,cy,r:radius,class:'spotlight'})); 
}

function drawPassArc(fr,to,t01){ 
  const ctrl={x:lerp(fr.x,to.x,.5),y:Math.min(fr.y,to.y)-80}; 
  const d=`M ${fr.x} ${fr.y} Q ${ctrl.x} ${ctrl.y} ${to.x} ${to.y}`; 
  const path=el('path',{d,class:'pass-arc'}); 
  path.setAttribute('pathLength',1); 
  const f=Math.max(0,Math.min(1,t01)); 
  path.setAttribute('stroke-dasharray',f+' '+(1-f)); 
  path.setAttribute('stroke-dashoffset',0); 
  gOverlay.appendChild(path); 
}

function drawTextLabel(text,x,y,anchor='start'){
  const label=el('text',{x,y,class:'text-label','text-anchor':anchor||'start'});
  label.textContent=text;
  gOverlay.appendChild(label);
}

function drawArrow(fromX,fromY,toX,toY,color='#fff'){
  const dx=toX-fromX;
  const dy=toY-fromY;
  const length=Math.sqrt(dx*dx+dy*dy);
  const angle=Math.atan2(dy,dx)*180/Math.PI;
  
  const shortenBy=20;
  const ratio=(length-shortenBy)/length;
  const endX=fromX+dx*ratio;
  const endY=fromY+dy*ratio;
  
  const line=el('line',{x1:fromX,y1:fromY,x2:endX,y2:endY,class:'arrow-line',stroke:color});
  gOverlay.appendChild(line);
  
  const headSize=12;
  const headAngle=25;
  const angle1=(angle-headAngle)*Math.PI/180;
  const angle2=(angle+headAngle)*Math.PI/180;
  const hx1=endX-headSize*Math.cos(angle1);
  const hy1=endY-headSize*Math.sin(angle1);
  const hx2=endX-headSize*Math.cos(angle2);
  const hy2=endY-headSize*Math.sin(angle2);
  
  const arrowhead=el('polygon',{
    points:`${endX},${endY} ${hx1},${hy1} ${hx2},${hy2}`,
    class:'arrow-head',
    fill:color
  });
  gOverlay.appendChild(arrowhead);
}

function setLabelsVisible(on){ 
  gLabels.style.display=on?'block':'none'; 
}

function renderFrame(t){
  if (!activeScenario) return;
  resetDynamicLayers(); 
  setLabelsVisible(toggleLabels.checked);
  for(const a of activeScenario.actions){
    const {type,start=0,end=start,easing='linear'}=a;
    const d=Math.max(1,end-start);
    const raw=(t-start)/d;
    const clamped=Math.min(1,Math.max(0,raw));
    const e=(Easing[easing]||Easing.linear)(clamped);
    if(type==='move'){ 
      const {id,from,to}=a; 
      setPlayerPos(id, lerp(from.x,to.x,e), lerp(from.y,to.y,e)); 
    }
    else if(type==='offsideLine'){ 
      const {xAtStart,xAtEnd}=a; 
      drawOffsideLineAtX(lerp(xAtStart,xAtEnd,e)); 
    }
    else if(type==='spotlight'){ 
      if(t>=start && t<=end) setSpotlight(a.id,a.radius); 
    }
    else if(type==='passArc'){ 
      drawPassArc(a.from,a.to,clamped); 
    }
    else if(type==='textLabel'){
      if(t>=start && t<=end) drawTextLabel(a.text,a.x,a.y,a.anchor);
    }
    else if(type==='arrow'){
      if(t>=start && t<=end) drawArrow(a.from.x,a.from.y,a.to.x,a.to.y,a.color||'#fff');
    }
  }
}

function play(){ 
  if(isPlaying) return; 
  isPlaying=true; 
  lastTick=performance.now(); 
  rafId=requestAnimationFrame(tick); 
}

function pause(){ 
  isPlaying=false; 
  if(rafId) cancelAnimationFrame(rafId); 
  rafId=null; 
}

function tick(now){ 
  const dt=now-lastTick; 
  lastTick=now; 
  currentTime+=dt*speed; 
  
  if(currentTime>=duration){ 
    if(toggleLoop.checked) {
      currentTime=0;
      lastTick=performance.now();
      renderFrame(0);
      scrubber.value="0";
      if(isPlaying) {
        rafId=requestAnimationFrame(tick);
      }
      return;
    } else {
      currentTime=duration;
      renderFrame(currentTime);
      scrubber.value=String(currentTime);
      pause();
      return;
    }
  } 
  
  if(currentTime<0) currentTime=0; 
  renderFrame(currentTime); 
  scrubber.value=String(currentTime); 
  
  if(isPlaying) rafId=requestAnimationFrame(tick); 
}

function snapshotPNG(){ 
  const s=new XMLSerializer().serializeToString(svg); 
  const blob=new Blob([s],{type:'image/svg+xml;charset=utf-8'}); 
  const url=URL.createObjectURL(blob); 
  const img=new Image(); 
  img.onload=function(){ 
    const c=document.createElement('canvas'); 
    c.width=1000; 
    c.height=650; 
    const ctx=c.getContext('2d'); 
    ctx.fillStyle='#146c2e'; 
    ctx.fillRect(0,0,c.width,c.height); 
    ctx.drawImage(img,0,0); 
    URL.revokeObjectURL(url); 
    const a=document.createElement('a'); 
    a.download=`${activeScenario.id || 'snapshot'}.png`; 
    a.href=c.toDataURL('image/png'); 
    a.click(); 
  }; 
  img.src=url; 
}

function computeAndSetDuration(scn){ 
  duration=computeDuration(scn); 
  scrubber.min="0"; 
  scrubber.max=String(duration); 
  scrubber.step="16"; 
  scrubber.value="0"; 
}

async function initScenario(scn){ 
  activeScenario=scn; 
  buildPitch(); 
  buildPlayersForScenario(scn); 
  buildAnnotationsForScenario(scn); 
  computeAndSetDuration(scn); 
  currentTime=0; 
  renderFrame(0); 
}

async function loadAndInitScenario(id) {
  try {
    pause();
    const scenario = await loadScenarioById(id);
    await initScenario(scenario);
  } catch (error) {
    console.error('Error loading scenario:', error);
    alert(`Could not load scenario: ${id}`);
  }
}

function getUrlParameter(name) {
  const params = new URLSearchParams(window.location.search);
  return params.get(name);
}

playBtn.addEventListener('click', play);
pauseBtn.addEventListener('click', pause);
speedSelect.addEventListener('change', ()=> speed=parseFloat(speedSelect.value||"1"));
scrubber.addEventListener('input', ()=>{ currentTime=parseFloat(scrubber.value||"0"); renderFrame(currentTime); });
toggleLabels.addEventListener('change', ()=> renderFrame(currentTime));
toggleOffside.addEventListener('change', ()=> renderFrame(currentTime));
scenarioSelect.addEventListener('change', async ()=> { await loadAndInitScenario(scenarioSelect.value); });
snapshotBtn.addEventListener('click', snapshotPNG);
window.addEventListener('load', setControlsHeightVar);
window.addEventListener('resize', setControlsHeightVar);

async function boot() {
  try {
    manifestData = await loadManifest();
    populateScenarioDropdown(manifestData);
    const urlId = getUrlParameter('id');
    let initialId = urlId || 'caughtOffside';
    scenarioSelect.value = initialId;
    await loadAndInitScenario(initialId);
  } catch (error) {
    console.error('Boot error:', error);
    alert('Failed to initialize application. Check console for details.');
  }
}

boot();
  </script>
</body>
</html>